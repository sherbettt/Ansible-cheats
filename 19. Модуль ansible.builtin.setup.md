 `ansible.builtin.setup` и `ansible.builtin.gather_facts` - это **один и тот же модуль** с разными именами. 
 Давайте рассмотрим их вместе.

## Идентичность модулей

- `ansible.builtin.setup` - оригинальное имя модуля
- `ansible.builtin.gather_facts` - псевдоним для удобства использования в плейбуках

## Общие параметры модуля

### filter
Фильтрация собираемых фактов

```yaml
- name: Использование filter с setup
  ansible.builtin.setup:
    filter: "ansible_*_mb"

- name: Использование filter с gather_facts  
  ansible.builtin.gather_facts:
    filter: "ansible_default_ipv4"
```

### gather_subset
Выбор подмножеств фактов для сбора

```yaml
- name: gather_subset с setup
  ansible.builtin.setup:
    gather_subset:
      - network
      - hardware

- name: gather_subset с gather_facts
  ansible.builtin.gather_facts:
    gather_subset:
      - "!hardware"
      - "!virtual"
```

### gather_timeout
Таймаут сбора фактов (секунды)

```yaml
- name: Таймаут с setup
  ansible.builtin.setup:
    gather_subset: all
    gather_timeout: 30

- name: Таймаут с gather_facts
  ansible.builtin.gather_facts:
    gather_timeout: 15
```

### fact_path
Путь к кастомным фактам

```yaml
- name: fact_path с setup
  ansible.builtin.setup:
    fact_path: /etc/ansible/facts.d

- name: fact_path с gather_facts
  ansible.builtin.gather_facts:
    fact_path: /custom/facts
```

## Сравнение использования

### В качестве задачи (task)

**Оба имени работают идентично:**

```yaml
- name: Сбор фактов через setup
  ansible.builtin.setup:
    gather_subset:
      - network

- name: Сбор фактов через gather_facts  
  ansible.builtin.gather_facts:
    gather_subset:
      - network
```

### На уровне плейбука

**Только `gather_facts`:**

```yaml
- name: Плейбук с автоматическим сбором фактов
  hosts: all
  gather_facts: true  # ✅ Правильно
  # gather_facts: yes
  # gather_facts: no
  tasks:
    - name: Задача
      debug:
        msg: "Факты собраны автоматически"
```

## Полная таблица параметров

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|-----------|
| `filter` | list/string | null | Фильтр фактов (wildcard) |
| `gather_subset` | list | all | Подмножества для сбора |
| `gather_timeout` | int | 10 | Таймаут в секундах |
| `fact_path` | string | /etc/ansible/facts.d | Путь к кастомным фактам |

## Практические примеры

### Пример 1: Базовое использование

```yaml
- name: Демонстрация идентичности модулей
  hosts: all
  gather_facts: false
  tasks:
    - name: Способ 1 - setup
      ansible.builtin.setup:
        gather_subset:
          - min
      register: facts1

    - name: Способ 2 - gather_facts
      ansible.builtin.gather_facts:
        gather_subset:
          - min
      register: facts2

    - name: Показать идентичность результатов
      ansible.builtin.debug:
        msg: "Факты идентичны: {{ facts1.ansible_facts == facts2.ansible_facts }}"
```

### Пример 2: Фильтрация фактов

```yaml
- name: Фильтрация различными способами
  hosts: all
  tasks:
    - name: Фильтр по wildcard (setup)
      ansible.builtin.setup:
        filter: "ansible_*_mb"
      register: memory_facts

    - name: Фильтр по конкретным фактам (gather_facts)
      ansible.builtin.gather_facts:
        filter:
          - "ansible_hostname"
          - "ansible_distribution"
      register: system_facts

    - name: Показать результаты
      ansible.builtin.debug:
        msg: |
          Память: {{ memory_facts.ansible_facts }}
          Система: {{ system_facts.ansible_facts }}
```

### Пример 3: Gather Subset

```yaml
- name: Различные подмножества фактов
  hosts: all
  tasks:
    - name: Только сетевая информация (setup)
      ansible.builtin.setup:
        gather_subset: network

    - name: Всё кроме hardware (gather_facts)
      ansible.builtin.gather_facts:
        gather_subset:
          - "all"
          - "!hardware"

    - name: Несколько подмножеств (setup)
      ansible.builtin.setup:
        gather_subset:
          - hardware
          - virtual
          - network
```

### Пример 4: Производительность

```yaml
- name: Оптимизация сбора фактов
  hosts: all
  gather_facts: false
  tasks:
    - name: Быстрый сбор минимальных фактов (gather_facts)
      ansible.builtin.gather_facts:
        gather_subset: min
        gather_timeout: 5

    - name: Полный сбор с таймаутом (setup)
      ansible.builtin.setup:
        gather_subset: all
        gather_timeout: 30
      when: need_full_facts | default(false)
```

### Пример 5: Кастомные факты

```yaml
- name: Работа с кастомными фактами
  hosts: all
  tasks:
    - name: Сбор с кастомным путем (setup)
      ansible.builtin.setup:
        fact_path: "/opt/our_facts"
        gather_subset: all

    - name: Сбор только кастомных фактов (gather_facts)
      ansible.builtin.gather_facts:
        fact_path: "/etc/company/facts"
        filter: "ansible_local"
```

## Когда что использовать

### Используйте `gather_facts:`
- **На уровне плейбука** для автоматического сбора
- **Когда нужна понятность** в плейбуках

### Используйте `setup:`
- **В ad-hoc командах**
- **Когда нужна обратная совместимость**
- **В коде, который должен быть явным**

### Ad-hoc команды

```bash
# Оба имени работают в ad-hoc
ansible all -m setup -a "filter=ansible_memory_mb"
ansible all -m gather_facts -a "gather_subset=network"
```

## Важные замечания

1. **Производительность идентична** - нет разницы в скорости
2. **Результаты идентичны** - возвращают одинаковые данные
3. **Параметры идентичны** - все параметры работают с обоими именами
4. **Единственное отличие** - `gather_facts` можно использовать на уровне плейбука

Вы можете смело использовать любой вариант в задачах - они полностью взаимозаменяемы!
