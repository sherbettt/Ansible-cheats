См.: [Using conditionals in loops](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_conditionals.html#using-conditionals-in-loops)
<br/> [Loops](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html)
<br/> [Lookups](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_lookups.html)


В Ansible условие `loop` используется для **повторения задачи несколько раз с разными значениями**, что делает код более компактным и удобочитаемым по сравнению с ручным перечислением задач.  

###  Основные цели `loop`:
1. **Итерация по списку значений** – выполнение одной задачи для каждого элемента списка.
2. **Замена устаревших конструкций** (`with_items`, `with_dict` и др.) – начиная с Ansible 2.5, `loop` считается более современным и рекомендуемым способом.
3. **Упрощение кода** – вместо нескольких одинаковых задач с разными параметрами можно использовать одну задачу с циклом.

###  Примеры использования:
#### 1. Простой перебор элементов списка
```yaml
- name: Create multiple users
  ansible.builtin.user:
    name: "{{ item }}"
    state: present
  loop:
    - alice
    - bob
    - charlie
```
Эта задача создаст трёх пользователей: `alice`, `bob` и `charlie`.

#### 2. Перебор списка словарей (более сложные данные)
```yaml
- name: Add several users with additional options
  ansible.builtin.user:
    name: "{{ item.name }}"
    uid: "{{ item.uid }}"
    groups: "{{ item.groups }}"
  loop:
    - { name: 'alice', uid: 1001, groups: 'wheel' }
    - { name: 'bob', uid: 1002, groups: 'sudo' }
```
Здесь для каждого пользователя задаются разные `uid` и группы.

#### 3. Использование `loop` с `register` (сохранение результатов)
```yaml
- name: Check connectivity to multiple hosts
  ansible.builtin.ping:
  loop: "{{ hosts }}"
  register: ping_results

- name: Show ping results
  ansible.builtin.debug:
    var: ping_results
```
Результаты каждой итерации сохраняются в `ping_results`.

###  Чем `loop` лучше старых конструкций (`with_*`)?
- **Единообразие** – вместо множества `with_items`, `with_dict`, `with_sequence` теперь один унифицированный `loop`.
- **Поддержка новых возможностей** – например, `loop.control` для управления поведением цикла (паузы, ограничения и т. д.).
- **Лучшая читаемость** – код становится чище и понятнее.

### ⚠ Важно:
- В старых версиях Ansible (до 2.5) использовались `with_items`, `with_dict` и др. В новых версиях они тоже работают, но рекомендуются к замене на `loop`.
- Для сложных циклов (например, с условиями или вложенными списками) можно использовать `loop` + фильтры Jinja2.

### Вывод:
`loop` в Ansible нужен для **удобного и эффективного выполнения повторяющихся задач**, сокращая дублирование кода и делая плейбуки более читаемыми. 

--------






