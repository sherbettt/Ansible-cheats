# –ú–æ–¥—É–ª—å `ansible.builtin.fetch`

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–æ–¥—É–ª—å `fetch` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ –Ω–∞ —É–ø—Ä–∞–≤–ª—è—é—â—É—é –º–∞—à–∏–Ω—É**. –ê–Ω–∞–ª–æ–≥ `scp` –∏–ª–∏ `rsync`, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Ansible.

## –°–∏–Ω—Ç–∞–∫—Å–∏—Å

```yaml
- name: –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
  ansible.builtin.fetch:
    src: –ø—É—Ç—å_–Ω–∞_—É–¥–∞–ª–µ–Ω–Ω–æ–º_—É–∑–ª–µ
    dest: –ø—É—Ç—å_–Ω–∞_—É–ø—Ä–∞–≤–ª—è—é—â–µ–π_–º–∞—à–∏–Ω–µ
    flat: yes/no
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∞—Ç—Ä–∏–±—É—Ç—ã)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|--------------|-----------|
| `src` | string | **–î–∞** | - | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —É–∑–ª–µ |
| `dest` | string | **–î–∞** | - | –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —É–ø—Ä–∞–≤–ª—è—é—â–µ–π –º–∞—à–∏–Ω–µ |
| `flat` | boolean | –ù–µ—Ç | no | –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–∞–π–ª –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ö–æ—Å—Ç–æ–≤ |
| `validate_checksum` | boolean | –ù–µ—Ç | yes | –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É |
| `checksum_algorithm` | string | –ù–µ—Ç | sha1 | –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏ (sha1, sha256, md5) |

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ë–∞–∑–æ–≤–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞

```yaml
- name: Copy log file from remote host
  ansible.builtin.fetch:
    src: /var/log/syslog
    dest: /tmp/backups/
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ `/tmp/backups/—Ö–æ—Å—ÇÂêç/var/log/syslog`

### 2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ö–æ—Å—Ç–æ–≤ (`flat`)

```yaml
- name: Copy file without host directory structure
  ansible.builtin.fetch:
    src: /etc/hosts
    dest: /tmp/backups/hosts
    flat: yes
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ `/tmp/backups/hosts`

### 3. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤

```yaml
- name: Copy multiple configuration files
  ansible.builtin.fetch:
    src: "{{ item }}"
    dest: /tmp/config_backups/
  loop:
    - /etc/hosts
    - /etc/resolv.conf
    - /etc/hostname
```

### 4. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π

```yaml
- name: Fetch file with checksum validation
  ansible.builtin.fetch:
    src: /important/data.txt
    dest: /backups/
    validate_checksum: yes
    checksum_algorithm: sha256
```

### 5. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è

```yaml
- name: Fetch file only if changed
  ansible.builtin.fetch:
    src: /var/log/app.log
    dest: /tmp/logs/
  register: fetch_result
  changed_when: fetch_result.changed
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤

### –ë–µ–∑ `flat: yes` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):
```
dest_directory/
‚îî‚îÄ‚îÄ hostname/
    ‚îî‚îÄ‚îÄ full/
        ‚îî‚îÄ‚îÄ path/
            ‚îî‚îÄ‚îÄ to/
                ‚îî‚îÄ‚îÄ file.txt
```

### –° `flat: yes`:
```
dest_directory/
‚îî‚îÄ‚îÄ file.txt
```

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã

### –°–±–æ—Ä –ª–æ–≥–æ–≤ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤:

```yaml
- name: Collect log files from all servers
  ansible.builtin.fetch:
    src: "/var/log/{{ item }}"
    dest: "/backups/logs/{{ ansible_date_time.date }}/"
  loop:
    - nginx/access.log
    - nginx/error.log
    - syslog
    - auth.log
```

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π:

```yaml
- name: Backup important configurations
  ansible.builtin.fetch:
    src: "{{ item }}"
    dest: "/backups/{{ inventory_hostname }}/"
  loop:
    - /etc/ssh/sshd_config
    - /etc/nginx/nginx.conf
    - /etc/mysql/my.cnf
    - /etc/redis/redis.conf
```

### –°–±–æ—Ä –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:

```yaml
- name: Gather diagnostic files
  ansible.builtin.fetch:
    src: "{{ item }}"
    dest: "/diagnostics/{{ inventory_hostname }}/"
  loop:
    - /var/log/dmesg
    - /proc/cpuinfo
    - /proc/meminfo
    - /etc/os-release
```

## –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (registered variables)

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–æ–¥—É–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

| –ê—Ç—Ä–∏–±—É—Ç | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|-----------|
| `dest` | string | –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å –∫—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Ñ–∞–π–ª |
| `md5sum` | string | MD5 —Ö–µ—à —Ñ–∞–π–ª–∞ |
| `checksum` | string | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º–∞) |
| `size` | integer | –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö |
| `changed` | boolean | –ò–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ |

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π:

```yaml
- name: Fetch file and show info
  ansible.builtin.fetch:
    src: /etc/hosts
    dest: /tmp/backups/
  register: fetch_result

- name: Display fetch results
  ansible.builtin.debug:
    msg: |
      File saved to: {{ fetch_result.dest }}
      File size: {{ fetch_result.size | filesizeformat }}
      Checksum: {{ fetch_result.checksum }}
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–î–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ansible.builtin.synchronize` –∏–ª–∏ `archive` + `fetch`
2. **–ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã** - –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π `rsync`
3. **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞** - —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ —Ñ–∞–π–ª–∞
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è** - –º–æ–¥—É–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —É–∑–ª–µ
5. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –∑–∞–¥–∞—á–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- –¢—Ä–µ–±—É–µ—Ç –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É–∑–ª–∞—Ö

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏

### –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º:

```yaml
- name: Create archive of log directory
  ansible.builtin.archive:
    path: /var/log/
    dest: /tmp/logs.tar.gz

- name: Fetch the archive
  ansible.builtin.fetch:
    src: /tmp/logs.tar.gz
    dest: /backups/
    flat: yes

- name: Cleanup temporary archive
  ansible.builtin.file:
    path: /tmp/logs.tar.gz
    state: absent
```

–ú–æ–¥—É–ª—å `fetch` –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤! üìÅ
