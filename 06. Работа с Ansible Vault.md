# Работа с Ansible Vault
<br/> [vault_guide](https://docs.ansible.com/ansible/latest/vault_guide/index.html)

Ansible Vault - это инструмент для шифрования конфиденциальных данных в Ansible, таких как пароли, ключи API и другие секреты.

## Основные команды ansible-vault

### Создание нового зашифрованного файла
```bash
ansible-vault create secret.yml
```
После выполнения команды вам будет предложено ввести пароль, который будет использоваться для шифрования/дешифрования.

### Шифрование существующего файла
```bash
ansible-vault encrypt secret.yml
```

### Просмотр зашифрованного файла
```bash
ansible-vault view secret.yml
```

### Редактирование зашифрованного файла
```bash
ansible-vault edit secret.yml
```

### Расшифровка файла
```bash
ansible-vault decrypt secret.yml
```

### Изменение пароля Vault
```bash
ansible-vault rekey secret.yml
```

## Примеры использования

### 1. Шифрование переменных

**secret.yml** до шифрования:
```yaml
db_password: Sup3rS3cr3tP@ss
api_key: A1B2-C3D4-E5F6-G7H8
```

После выполнения `ansible-vault encrypt secret.yml`:
```yaml
$ANSIBLE_VAULT;1.1;AES256
33613361326662303438633635313062666561613038386534376234376233386464386530373961
3838653137333530323639663034396661343033366134380a393464646162633539313763353239
...
```

### 2. Использование в playbook

**playbook.yml**:
```yaml
- hosts: all
  vars_files:
    - secret.yml
  tasks:
    - name: Use secret password
      debug:
        msg: "DB password is {{ db_password }}"
```

Запуск playbook с запросом пароля:
```bash
ansible-playbook playbook.yml --ask-vault-pass
```

Или с файлом пароля:
```bash
ansible-playbook playbook.yml --vault-password-file ~/.vault_pass.txt
```

### 3. Шифрование отдельных переменных

**group_vars/all/vault.yml**:
```yaml
vault_db_password: "Sup3rS3cr3tP@ss"
vault_api_key: "A1B2-C3D4-E5F6-G7H8"
```

Шифруем файл:
```bash
ansible-vault encrypt group_vars/all/vault.yml
```

### 4. Использование зашифрованных переменных с незашифрованными

**group_vars/all/vars.yml** (незашифрованный):
```yaml
db_user: app_user
db_name: my_app_db
```

**group_vars/all/vault.yml** (зашифрованный):
```yaml
vault_db_password: "Sup3rS3cr3tP@ss"
```

### 5. Шифрование строки для использования в playbook

```bash
ansible-vault encrypt_string 'S3cr3tP@ss' --name 'vaulted_password'
```

Результат (который можно вставить в playbook или vars файл):
```yaml
vaulted_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66386439653236336462626566653063336164623961343765663438343832653639323138363862
          3132646465363166663862633535303535323662666137620a316338383939393839666336353339
          32373631613238623461386361396162616537396237396534376431343964353938383761616232
          3639636437633961620a383666613936383834633939376365303765373363323066313365373331
          6564
```

## Советы по работе с Ansible Vault

1. **Хранение пароля**: Лучше хранить пароль в файле с ограниченными правами (600) и использовать `--vault-password-file`
2. **.gitignore**: Добавьте файл с паролем в .gitignore
3. **Идентификация**: Используйте префикс `vault_` для зашифрованных переменных
4. **Множественные пароли**: Можно использовать разные пароли для разных файлов
5. **Автоматизация**: Для CI/CD можно передавать пароль через переменную окружения:
   ```bash
   ansible-playbook playbook.yml --vault-password-file <(echo $VAULT_PASS)
   ```

6. **Проверка**: Проверить, что файл зашифрован можно командой:
   ```bash
   ansible-vault is_encrypted secret.yml && echo "Encrypted"
   ```
------------------


## Дополнительные возможности и советы

### Использование нескольких vault-паролей

Ansible поддерживает работу с несколькими паролями через файл-скрипт:

**vault-password.py**:
```python
#!/usr/bin/env python3
import os

# Определяем какой пароль возвращать в зависимости от файла
if os.path.basename(__file__) == 'production_vault':
    print('production_password')
elif 'staging' in os.path.basename(__file__):
    print('staging_password')
else:
    print('default_password')
```

Сделайте скрипт исполняемым и используйте:
```bash
ansible-playbook playbook.yml --vault-password-file vault-password.py
```

### Интеграция с внешними системами хранения паролей

Можно интегрировать с HashiCorp Vault, AWS Secrets Manager и другими системами:

```python
#!/usr/bin/env python3
import hvac
import os

client = hvac.Client(url=os.getenv('VAULT_ADDR'), token=os.getenv('VAULT_TOKEN'))
secret = client.secrets.kv.v2.read_secret_version(path='ansible/vault')
print(secret['data']['data']['password'])
```

### Автоматизация в CI/CD пайплайнах

**GitLab CI example**:
```yaml
deploy:
  stage: deploy
  before_script:
    - mkdir -p ~/.ssh
    - echo "$VAULT_PASSWORD" > ~/.vault_pass
    - chmod 600 ~/.vault_pass
  script:
    - ansible-playbook deploy.yml --vault-password-file ~/.vault_pass
```

### Шифрование только определенных переменных в файле

Иногда полезно шифровать только конкретные значения:

**partial_encrypt.py**:
```python
#!/usr/bin/env python3
import yaml
from ansible.parsing.vault import VaultLib
from ansible.constants import DEFAULT_VAULT_ID_MATCH

vault = VaultLib([('default', lambda: 'your_password')])

data = {
    'public_var': 'visible_to_all',
    'secret_var': vault.encrypt('my_secret')
}

with open('output.yml', 'w') as f:
    yaml.dump(data, f)
```

### Валидация зашифрованного контента

Проверка синтаксиса зашифрованных файлов:
```bash
ansible-vault view secret.yml | python -c 'import yaml,sys; yaml.safe_load(sys.stdin.read())'
```

### Миграция между паролями

Безопасная смена пароля для всех файлов:
```bash
# Создаем временный файл со старым паролем
echo "old_password" > old_pass.txt
echo "new_password" > new_pass.txt

# Меняем пароль для всех .yml файлов
find . -name "*.yml" -exec ansible-vault rekey {} --vault-password-file old_pass.txt --new-vault-password-file new_pass.txt \;
```

### Отладка проблем

Если возникают проблемы с vault:

1. **Проверка шифрования**:
```bash
ansible-vault is_encrypted file.yml && echo "Encrypted" || echo "Not encrypted"
```

2. **Просмотр метаданных**:
```bash
head -1 encrypted_file.yml  # Показывает версию vault
```

3. **Поиск всех зашифрованных файлов**:
```bash
grep -r "\$ANSIBLE_VAULT" . --include="*.yml"
```

### Безопасные практики

1. **Никогда не коммитьте пароли**:
```bash
# .gitignore
*.vault_pass
vault_password*
*.secret
```

2. **Используйте разные пароли для сред**:
```bash
# inventory/production/group_vars/all/vault.yml - один пароль
# inventory/staging/group_vars/all/vault.yml - другой пароль
```

3. **Регулярная ротация паролей**:
```bash
# Скрипт для автоматической ротации паролей раз в 90 дней
```
