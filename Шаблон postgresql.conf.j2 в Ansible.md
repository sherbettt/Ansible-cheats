Для файла `postgresql.conf.j2` можно добавить несколько важных параметров PostgreSQL, которые часто настраиваются в зависимости от нагрузки и характеристик сервера.  

### **Рекомендуемые переменные для добавления:**
1. **Основные настройки памяти и процессов:**
   ```jinja2
   max_connections = {{ postgresql_max_connections }}
   listen_addresses = '{{ postgresql_listen_addresses }}'
   port = {{ postgresql_port }}
   ```

      Размер памяти для postgresql можно посчитать, написав скрипт:
      ```bash
      #!/bin/bash

      # Получаем общий объём RAM в KB
      total_ram_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
      total_ram_mb=$(($total_ram_kb / 1000))
      # total_ram_mb=$(($total_ram_kb / 1000))
      
      # Вычисляем 25% в MB
      shared_buffers_mb=$(($total_ram_kb * 25 / 100 / 1024))
      
      echo "total RAM = ${total_ram_mb} MB"
      echo "shared_buffers = ${shared_buffers_mb} MB"
      ```
   

2. **Настройки Write-Ahead Log (WAL):**
   ```jinja2
   wal_level = '{{ postgresql_wal_level }}'
   synchronous_commit = {{ postgresql_synchronous_commit }}
   checkpoint_timeout = '{{ postgresql_checkpoint_timeout }}'
   checkpoint_completion_target = {{ postgresql_checkpoint_completion_target }}
   ```

3. **Настройки производительности:**
   ```jinja2
   random_page_cost = {{ postgresql_random_page_cost }}
   effective_io_concurrency = {{ postgresql_effective_io_concurrency }}
   max_worker_processes = {{ postgresql_max_worker_processes }}
   max_parallel_workers_per_gather = {{ postgresql_max_parallel_workers_per_gather }}
   ```

4. **Логирование:**
   ```jinja2
   log_destination = '{{ postgresql_log_destination }}'
   logging_collector = {{ postgresql_logging_collector }}
   log_directory = '{{ postgresql_log_directory }}'
   log_filename = '{{ postgresql_log_filename }}'
   log_rotation_age = '{{ postgresql_log_rotation_age }}'
   log_rotation_size = '{{ postgresql_log_rotation_size }}'
   ```

5. **Аутентификация:**
   ```jinja2
   password_encryption = '{{ postgresql_password_encryption }}'
   ```



---

### **Где брать значения переменных?**
1. **Официальная документация PostgreSQL:**  
   - [PostgreSQL Tuning](https://www.postgresql.org/docs/current/runtime-config-resource.html)  
   - [PostgreSQL Configuration](https://www.postgresql.org/docs/current/runtime-config.html)  

2. **Рекомендации по настройке в зависимости от ОЗУ и диска:**  
   - **`shared_buffers`** – обычно 25% от RAM (но не более 8-16 ГБ).  
   - **`effective_cache_size`** – ~75% от RAM.  
   - **`work_mem`** – `(RAM - shared_buffers) / (max_connections * 2)`.  
   - **`maintenance_work_mem`** – до 2 ГБ для серверов с большими таблицами.  

3. **Пример значений для сервера с 16 ГБ RAM:**
   ```yaml
   postgresql_ram_shared: "4GB"
   postgresql_ram_cache: "12GB"
   postgresql_work_mem: "32MB"
   postgresql_maintenance_work_mem: "1GB"
   postgresql_max_connections: 100
   postgresql_wal_level: "replica"
   postgresql_checkpoint_timeout: "15min"
   postgresql_checkpoint_completion_target: 0.9
   postgresql_random_page_cost: 1.1  # для SSD
   postgresql_effective_io_concurrency: 200  # для NVMe/SSD
   ```

4. **Автоматические калькуляторы:**  
   - [PGTune](https://pgtune.leopard.in.ua/) – помогает рассчитать параметры на основе характеристик сервера.  
   - [PGConfig](https://pgconfig.org/) – генерирует конфиг под заданные параметры.  

---

### **Где хранить переменные?**
- В `group_vars/` для разных групп серверов (например, `group_vars/postgresql_servers.yml`).  
- В `host_vars/` для специфичных настроек под конкретный сервер.  
- В роли (если используется Ansible Role) – `defaults/main.yml` или `vars/main.yml`.  

Пример структуры:
```yaml
# group_vars/postgresql_servers.yml
postgresql_port: 5432
postgresql_listen_addresses: "0.0.0.0"
postgresql_max_connections: 200
postgresql_wal_level: "replica"
postgresql_password_encryption: "scram-sha-256"
```
----------------
**Пример значений для моего сервера с 4 ГБ RAM:**
   ```yaml
# postgresql.conf.j2
# shared_buffers = {{ postgresql_ram_shared }}
# effective_cache_size = {{ postgresql_ram_cache }}
# work_mem = {{ postgresql_work_mem }}
# maintenance_work_mem = {{ postgresql_maintenance_work_mem }}


# Generated by PGConfig 3.1.4 (1fe6d98dedcaad1d0a114617cfd08b4fed1d8a01)
# https://api.pgconfig.org/v1/tuning/get-config?format=conf&include_pgbadger=true&log_format=csvlog&max_connections=100&pg_version=15&environment_name=WEB&total_ram=4GB&cpus=32&drive_type=SSD&arch=x86-64&os_type=unix

# Memory Configuration
shared_buffers = 1GB  # 512MB
effective_cache_size = 3GB
work_mem = 10MB
maintenance_work_mem = 205MB

# Checkpoint Related Configuration
min_wal_size = 2GB
max_wal_size = 3GB
checkpoint_completion_target = 0.9
wal_buffers = -1

# Network Related Configuration
listen_addresses = 'localhost,192.168.56.1'
max_connections = 100

# Storage Configuration
random_page_cost = 1.1
effective_io_concurrency = 200

# Worker Processes Configuration
max_worker_processes = 8
max_parallel_workers_per_gather = 2
max_parallel_workers = 2

# Logging configuration for pgbadger
logging_collector = on
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
lc_messages = 'C'

# Adjust the minimum time to collect the data
log_min_duration_statement = '10s'
log_autovacuum_min_duration = 0

# CSV Configuration
log_destination = 'csvlog'
   ```
