Директива `with_fileglob` в Ansible — это **цикл**, который позволяет выполнить задачу для каждого файла, соответствующего указанному шаблону (глоб-паттерну). Она похожа на использование `*` в командной строке для поиска файлов.

## Как работает `with_fileglob`:

1. **Ищет файлы** на **управляющей машине** (где запускается Ansible) по указанному пути-шаблону
2. **Для каждого найденного файла** выполняет задачу один раз
3. **Переменная `{{ item }}`** содержит полный путь к найденному файлу

## Разбор вашего примера:

### Пример 1: Загрузка файлов на репозиторий
```yaml
- name: upload files to repo
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/tmp/debs/deb11/"
    mode: 0777
  with_fileglob:
    - "/var/lib/jenkins/workspace/*{{manager_version}}_*.deb"
```

**Что происходит:**
1. Ansible ищет на Jenkins-сервере файлы по шаблону: `/var/lib/jenkins/workspace/*2.21.52-1475-deb11_*.deb`
2. Для каждого найденного .deb-файла выполняет копирование на удаленный сервер
3. Например, если найдет файлы:
   - `runtel-core-v2_2.21.52-1475-deb11_amd64.deb`
   - `runtel-cdr-v2_2.21.52-1475-deb11_amd64.deb`

### Пример 2: Очистка workspace
```yaml
- name: clean
  ansible.builtin.file:
    name: "{{ item }}"
    state: absent
  with_fileglob:
    - "/var/lib/jenkins/workspace/*{{manager_version}}_*"
```

**Что происходит:**
1. Ищет все файлы, содержащие версию: `*2.21.52-1475-deb11_*`
2. Удаляет каждый найденный файл

## Практический пример:

Допустим, в папке `/var/lib/jenkins/workspace/` есть файлы:
```
runtel-core-v2_2.21.52-1475-deb11_amd64.deb
runtel-cdr-v2_2.21.52-1475-deb11_amd64.deb  
runtel-event-hunter-v2_2.21.52-1475-deb11_amd64.deb
config.txt
```

С `with_fileglob` задача выполнится **3 раза** (только для .deb файлов):
- Копирует `runtel-core-v2_...deb` на репозиторий
- Копирует `runtel-cdr-v2_...deb` на репозиторий  
- Копирует `runtel-event-hunter-v2_...deb` на репозиторий

## Важные особенности:

1. **Поиск на управляющей машине** - файлы ищутся там, где запущен Ansible
2. **Относительные пути** - можно использовать относительные пути от плейбука
3. **Рекурсивный поиск** - `**/*.deb` найдет все .deb файлы в подпапках
4. **Не находит директории** - только файлы

## Альтернативы:

```yaml
# Рекурсивный поиск во всех подпапках
with_fileglob:
  - "**/*{{manager_version}}_*.deb"

# Несколько шаблонов
with_fileglob:
  - "*.deb"
  - "*.rpm"
```
-----------------------

```yaml
- name: Display paths of all .txt files in dir
  ansible.builtin.debug: msg={{ lookup('ansible.builtin.fileglob', '/my/path/*.txt') }}

- name: Copy each file over that matches the given pattern
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/etc/fooapp/"
    owner: "root"
    mode: 0600
  with_fileglob:
    - "/playbooks/files/fooapp/*"
```

Пример из https://docs.ansible.com/ansible/latest/collections/ansible/builtin/fileglob_lookup.html

Разберем оба примера по частям.

## Пример 1: Просто отображение файлов

```yaml
- name: Display paths of all .txt files in dir
  ansible.builtin.debug: 
    msg: "{{ lookup('ansible.builtin.fileglob', '/my/path/*.txt') }}"
```

**Что происходит:**
1. **`lookup('ansible.builtin.fileglob', '/my/path/*.txt')`** - это функция поиска файлов
2. Ищет все файлы с расширением `.txt` в папке `/my/path/`
3. **Возвращает список путей** найденных файлов
4. **`debug: msg=`** - выводит весь список сразу в одном сообщении

**Результат:**  
Если в `/my/path/` есть файлы `a.txt`, `b.txt`, `c.txt`, то вывод будет:
```
ok: [server] => {
    "msg": [
        "/my/path/a.txt",
        "/my/path/b.txt", 
        "/my/path/c.txt"
    ]
}
```

## Пример 2: Копирование файлов через цикл

```yaml
- name: Copy each file over that matches the given pattern
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/etc/fooapp/"
    owner: "root"
    mode: 0600
  with_fileglob:
    - "/playbooks/files/fooapp/*"
```

**Разберем по шагам:**

### Шаг 1: Поиск файлов
```yaml
with_fileglob:
  - "/playbooks/files/fooapp/*"
```
- Ищет **все файлы** в папке `/playbooks/files/fooapp/`
- Например, находит: `app.conf`, `settings.ini`, `script.sh`

### Шаг 2: Цикл выполнения
Задача выполняется **для каждого найденного файла**:

**Первая итерация:**
- `{{ item }}` = `/playbooks/files/fooapp/app.conf`
- Копирует `app.conf` в `/etc/fooapp/`

**Вторая итерация:**
- `{{ item }}` = `/playbooks/files/fooapp/settings.ini`  
- Копирует `settings.ini` в `/etc/fooapp/`

**Третья итерация:**
- `{{ item }}` = `/playbooks/files/fooapp/script.sh`
- Копирует `script.sh` в `/etc/fooapp/`

### Шаг 3: Параметры копирования
Для каждого файла применяются:
- `owner: "root"` - владелец файла
- `mode: 0600` - права доступа (только чтение для владельца)

## Ключевые отличия двух подходов:

| Характеристика | Пример 1 (lookup) | Пример 2 (with_fileglob) |
|----------------|-------------------|--------------------------|
| **Тип** | Один вывод всего списка | Цикл для каждого файла |
| **Использование** | Только просмотр | Выполнение действий |
| **Вывод** | Все пути в одном сообщении | Отдельные задачи для каждого файла |
| **Производительность** | Быстрее | Медленнее (много задач) |

## Практический пример из вашего плейбука:

```yaml
- name: upload files to repo
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/tmp/debs/deb11/"
    mode: 0777
  with_fileglob:
    - "/var/lib/jenkins/workspace/*{{manager_version}}_*.deb"
```

**Работает так:**
1. Находит все .deb файлы с версией `2.21.52-1475-deb11` в workspace Jenkins
2. Для каждого файла выполняет копирование на удаленный сервер
3. `{{ item }}` поочередно становится путем к каждому найденному .deb файлу

**В вашем случае** проблема может быть в том, что шаблон `*{{manager_version}}_*.deb` находит не только нужные файлы версии `2.21.52-1475-deb11`, но и другие файлы, содержащие эту подстроку в названии.
